version: '3.8'

services:
  aigateway:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_UID: ${AIGATEWAY_UID:-1000}
        APP_GID: ${AIGATEWAY_GID:-1000}
        APP_USER: appuser
        APP_GROUP: appuser
    
    container_name: aigateway
    
    # NOTE: Container starts as root to fix volume permissions,
    # then entrypoint.sh drops to appuser (UID/GID) via gosu.
    # Do NOT set user: here - let entrypoint handle it.
    
    ports:
      - "8080:8080"
    
    environment:
      # ASP.NET Core
      DOTNET_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      
      # Gateway Configuration
      Gateway__MasterKey: ${AIGATEWAY_MASTER_KEY}
      Gateway__DatabasePath: /data/apikeys.sqlite
      Gateway__LogPath: /logs/log-.txt
      Gateway__LogRetentionDays: 31
      Gateway__EnableHttpsRedirection: "false"
      Gateway__MaxRequestBodyMb: ${Gateway__MaxRequestBodyMb:-300}
      
      # Serilog Configuration
      Serilog__WriteTo__1__Args__path: /logs/log-.txt
      
      # Upstream Services
      Upstreams__SpeachesBaseUrl: ${SPEACHES_BASE_URL}
      Upstreams__OllamaBaseUrl: ${OLLAMA_BASE_URL}
      
      # Ollama Configuration
      Ollama__DefaultModel: ${OLLAMA_DEFAULT_MODEL:-llama3.2}
      Ollama__RequestTimeoutSeconds: ${OLLAMA_TIMEOUT:-120}
      
      # Pass UID/GID to entrypoint script
      APP_UID: ${AIGATEWAY_UID:-1000}
      APP_GID: ${AIGATEWAY_GID:-1000}
    
    volumes:
      # Persistent storage for SQLite database
      # Entrypoint script automatically fixes permissions
      - ./data:/data
      # Persistent storage for logs
      - ./logs:/logs
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - aigateway-network

networks:
  aigateway-network:
    driver: bridge
